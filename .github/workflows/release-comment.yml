on:
  release:
    types: [published]

permissions:
  contents: read

jobs:
  comment-prs:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # need full history

      - uses: actions/github-script@v7
        with:
          script: |
            const tag = context.payload.release.tag_name;
            const releaseUrl = context.payload.release.html_url;

            // Get previous tag
            const tags = await github.rest.repos.listTags({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 10
            });
            const prevTag = tags.data[1]?.name;  // index 0 is current tag

            // Compare commits between tags
            const comparison = await github.rest.repos.compareCommitsWithBasehead({
              owner: context.repo.owner,
              repo: context.repo.repo,
              basehead: `${prevTag}...${tag}`
            });

            const prNumbers = new Set();
            for (const commit of comparison.data.commits) {
              // GitHub merge commits include "(#123)" in the message
              const matches = commit.commit.message.matchAll(/#(\d+)/g);
              for (const match of matches) {
                prNumbers.add(parseInt(match[1]));
              }
            }

            // Also search for PRs via API (catches squash merges)
            for (const commit of comparison.data.commits) {
              const prs = await github.rest.repos.listPullRequestsAssociatedWithCommit({
                owner: context.repo.owner,
                repo: context.repo.repo,
                commit_sha: commit.sha
              });
              for (const pr of prs.data) {
                prNumbers.add(pr.number);
              }
            }

            // Comment on each PR
            for (const prNumber of prNumbers) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: `ðŸš€ This PR is included in [${tag}](${releaseUrl})`
              });
            }

  notify-discord:
    runs-on: ubuntu-latest
    steps:
      - name: Send Discord notification
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          RELEASE_BODY_JSON: ${{ toJSON(github.event.release.body) }}
        run: |
          TAG="${{ github.event.release.tag_name }}"
          RELEASE_URL="${{ github.event.release.html_url }}"
          RELEASE_NAME="${{ github.event.release.name }}"
          if [ ${#RELEASE_BODY_JSON} -gt 1800 ]; then
            BODY=$(echo $RELEASE_BODY_JSON | head -c 1797 | sed 's/[^"]*$//')
            BODY="${BODY%\"}...\""
          else
            BODY=$RELEASE_BODY_JSON
          fi

          curl -s -X POST "$DISCORD_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "{
              \"embeds\": [{
                \"title\": \"New Release: ${RELEASE_NAME:-$TAG}\",
                \"url\": \"$RELEASE_URL\",
                \"description\": $BODY,
                \"color\": 16711840
              }]
            }"
